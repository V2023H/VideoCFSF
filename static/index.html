<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Go è§†é¢‘æ–‡ä»¶æŸåæ£€æŸ¥å·¥å…·</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end; }
        .controls div { flex-grow: 1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #a0c3e8; cursor: not-allowed; }
        
        /* åˆ—è¡¨å’Œæ—¥å¿—åŒºåŸŸ */
        .results-section, .log-section { margin-top: 25px; padding: 15px; border: 1px solid #eee; border-radius: 4px; background-color: #fafafa; }
        .results-section h2, .log-section h2 { margin-top: 0; color: #007bff; font-size: 1.2em; }
        
        /* åˆ—è¡¨æ ·å¼ */
        #fileList { max-height: 400px; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #fileList li { padding: 8px; border-bottom: 1px dotted #ddd; display: flex; justify-content: space-between; align-items: center; }
        #fileList li:last-child { border-bottom: none; }
        .status { font-weight: bold; padding: 2px 8px; border-radius: 3px; font-size: 0.9em; }
        .status.ok { background-color: #e6ffed; color: #10ac47; }
        .status.broken { background-color: #ffe6e6; color: #dc3545; }

        /* æ—¥å¿—æ ·å¼ */
        #logArea { height: 150px; overflow-y: scroll; background-color: #333; color: #f4f7f6; padding: 10px; font-size: 0.9em; border-radius: 4px; white-space: pre-wrap; }

        /* è¿›åº¦æ¡ */
        .progress-container { margin-top: 15px; background-color: #e9ecef; border-radius: 50px; height: 25px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: #28a745; text-align: center; color: white; line-height: 25px; transition: width 0.4s ease; font-weight: bold; }
        #progressText { margin-top: 5px; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <button id="cleardbButton" style="margin-top: 24px;float: right;background: red;">æ¸…é™¤è®°å½•</button>
    <button id="printdbButton" style="margin-top: 24px;margin-right: 10px;float: right;background: #007bff;">æ‰“å°è®°å½•</button>
    <!-- <button id="moveBrokenButton" style="margin-top: 24px;margin-right: 10px;float: right;background: orange;">ç§»åŠ¨æŸåæ–‡ä»¶</button>
    <button id="moveNormalButton" style="margin-top: 24px;margin-right: 10px;float: right;background: orange;">ç§»åŠ¨æ­£å¸¸æ–‡ä»¶</button> -->
    <h1>ğŸ¬ è§†é¢‘æ–‡ä»¶æŸåæ£€æŸ¥</h1>

    <div class="controls">
        <div style="width: 50%;">
            <label for="directoryPath">ç›®æ ‡ä¸æºç›®å½•è·¯å¾„</label>
            <input type="text" id="directoryPath" value="" placeholder="è¯·è¾“å…¥è¦æ‰«æçš„ç›®å½•è·¯å¾„ (ä¾‹å¦‚: C:\Videos æˆ– /home/user/videos)">
        </div>
        <div>
            <label for="scanMode">æ£€æŸ¥æ–¹å¼</label>
            <select id="scanMode">
                <option value="quick">å¿«é€Ÿæ£€æŸ¥ (ffprobe æµä¿¡æ¯)</option>
                <option value="full">å®Œæ•´æ£€æŸ¥ (ç”»é¢å’Œé»‘ç›’æ£€æµ‹)</option>
            </select>
        </div>
        <div>
            <label for="scanType">é‡å¤è®°å½•</label>
            <select id="scanType">
                <option value="skip1">è·³è¿‡å…¨éƒ¨</option>
                <option value="skip2">è·³è¿‡æ­£å¸¸</option>
            </select>
        </div>
        <div>
            <button id="startButton">å¼€å§‹</button>
        </div>
    </div>

    <div class="progress-container">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <div id="progressText">ç­‰å¾…å¼€å§‹...</div>

    <div class="results-section">
        <h2>æ£€æŸ¥ç»“æœåˆ—è¡¨</h2>
        <ul id="fileList">
            </ul>
    </div>

    <div class="log-section">
        <h2>æ‰§è¡Œæ—¥å¿—</h2>
        <pre id="logArea">ç­‰å¾…è¿æ¥åç«¯...</pre>
    </div>
</div>

<script>
    const logArea = document.getElementById('logArea');
    const fileList = document.getElementById('fileList');
    const startButton = document.getElementById('startButton');
    const printdbButton = document.getElementById('printdbButton');
    const cleardbButton = document.getElementById('cleardbButton');
    const moveBrokenButton = document.getElementById('moveBrokenButton');
    const moveNormalButton = document.getElementById('moveNormalButton');
    const directoryPath = document.getElementById('directoryPath');
    const scanMode = document.getElementById('scanMode');
    const scanType = document.getElementById('scanType');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    document.getElementById('directoryPath').value = '/home/1/23';
    document.getElementById('scanMode').value = 'full';
    document.getElementById('scanType').value = 'skip1';
    
    // WebSocket è¿æ¥å»ºç«‹
    const ws = new WebSocket("ws://" + window.location.host + "/ws");
    
    let isScanning = false;

    ws.onopen = () => {
        logMessage("ç³»ç»Ÿ", "âœ… å·²è¿æ¥åˆ° Go åç«¯æœåŠ¡ã€‚", true);
        startButton.disabled = false;
        startButton.textContent = "å¼€å§‹";
    };
    
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        
        switch (msg.type) {
            case "log":
                logMessage("åç«¯", msg.content, true);
                break;
            case "progress":
                updateProgress(msg.current, msg.total, msg.content);
                if (msg.current === msg.total && msg.total !== 0) {
                    isScanning = false;
                    startButton.disabled = false;
                    startButton.textContent = "é‡æ–°å¼€å§‹";
                }else{
                    isScanning = true;
                    startButton.disabled = true;
                    startButton.textContent = "æ­£åœ¨æ£€æŸ¥";
                }
                break;
            case "result":
                addResultToList(msg.path, msg.status);
                break;
        }
    };

    ws.onclose = () => {
        logMessage("ç³»ç»Ÿ", "âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡å¯ Go åç«¯ç¨‹åºã€‚", true);
        startButton.disabled = true;
        isScanning = false;
    };

    ws.onerror = (error) => {
        logMessage("ç³»ç»Ÿ", "âŒ WebSocket é”™è¯¯: " + error.message, true);
    };

    // --- DOM æ“ä½œå‡½æ•° ---

    function logMessage(source, content, autoScroll = false) {
        const time = new Date().toLocaleTimeString();
        logArea.textContent += `[${time}][${source}] ${content}\n`;
        if (autoScroll) {
            logArea.scrollTop = logArea.scrollHeight;
        }
    }
    
    function updateProgress(current, total, text) {
        if (total === 0) {
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressText.textContent = "ç­‰å¾…å¼€å§‹...";
            return;
        }
        
        const percent = Math.floor((current / total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressText.textContent = `${text} (å·²æ£€æŸ¥ ${current} / å…± ${total} ä¸ªæ–‡ä»¶)`;
    }

    function addResultToList(path, status) {
        // åˆ›å»ºæ–°çš„åˆ—è¡¨é¡¹
        const li = document.createElement('li');
        
        // æå–æ–‡ä»¶å
        //const filename = path.split(/[\/\\]/).pop();
        const filename = path;

        // çŠ¶æ€ Span
        const statusSpan = document.createElement('span');
        statusSpan.className = `status ${status}`;
        switch (status) {
            case 'ok':
                statusSpan.textContent =  'æ­£å¸¸'
                break;
            case 'broken':
                statusSpan.textContent =  'æŸå'
                break;
            case 'skipped':
                statusSpan.textContent =  'è·³è¿‡'
                break;
            default:
                break;
        }

        // æ–‡ä»¶è·¯å¾„/å
        const pathSpan = document.createElement('span');
        pathSpan.textContent = filename;
        pathSpan.title = path; // å®Œæ•´è·¯å¾„ä½œä¸ºæç¤º

        li.appendChild(pathSpan);
        li.appendChild(statusSpan);
        
        // å°†æ–°ç»“æœæ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
        if (status != "skipped"){fileList.insertBefore(li, fileList.firstChild);}
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ ---

    startButton.addEventListener('click', () => {
        if (isScanning) return;
        
        const dir = directoryPath.value.trim();
        if (!dir) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®å½•è·¯å¾„ï¼");
            return;
        }

        // çŠ¶æ€åˆ‡æ¢å’Œæ¸…ç†
        isScanning = true;
        startButton.disabled = true;
        startButton.textContent = "æ­£åœ¨æ£€æŸ¥";
        fileList.innerHTML = ''; // æ¸…ç©ºç»“æœåˆ—è¡¨
        logArea.textContent = ''; // æ¸…ç©ºæ—¥å¿—
        logMessage("ç³»ç»Ÿ", `æ”¶åˆ°è¯·æ±‚ï¼Œå¼€å§‹æ£€æŸ¥ç›®å½•: ${dir}`, true);
        updateProgress(0, 0, ""); // é‡ç½®è¿›åº¦æ¡

        // å‘é€è¯·æ±‚ç»™åç«¯
        const request = {
            directory: dir,
            scanMode: scanMode.value,
            scanType: scanType.value
        };
        ws.send(JSON.stringify(request));
    });

    printdbButton.addEventListener('click', () => {
        if (isScanning) return;
        
        const dir = directoryPath.value.trim();
        if (!dir) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®å½•è·¯å¾„ï¼");
            return;
        }

        fileList.innerHTML = ''; // æ¸…ç©ºç»“æœåˆ—è¡¨
        logArea.textContent = ''; // æ¸…ç©ºæ—¥å¿—
        logMessage("ç³»ç»Ÿ", `å¼€å§‹æ‰“å°éªŒè¯è®°å½•: ${dir}`, true);
        updateProgress(0, 0, ""); // é‡ç½®è¿›åº¦æ¡

        // å‘é€è¯·æ±‚ç»™åç«¯
        const request = {
            directory: dir,
            scanMode: "printdb",
            scanType: scanType.value
        };
        ws.send(JSON.stringify(request));
    });
    cleardbButton.addEventListener('click', () => {
        if (isScanning) return;
        
        const dir = directoryPath.value.trim();
        if (!dir) {
            alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®å½•è·¯å¾„ï¼");
            return;
        }

        // çŠ¶æ€åˆ‡æ¢å’Œæ¸…ç†
        logMessage("ç³»ç»Ÿ", `æ”¶åˆ°è¯·æ±‚ï¼Œå¼€å§‹æ¸…ç†è®°å½•`, true);

        // å‘é€è¯·æ±‚ç»™åç«¯
        const request = {
            directory: dir,
            scanMode: "cleardb",
            scanType: ""
        };
        ws.send(JSON.stringify(request));
    });
    if (moveBrokenButton != null){
        moveBrokenButton.addEventListener('click', () => {
            if (isScanning) return;
            
            const dir = directoryPath.value.trim();
            if (!dir) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®å½•è·¯å¾„ï¼");
                return;
            }

            // çŠ¶æ€åˆ‡æ¢å’Œæ¸…ç†
            logMessage("ç³»ç»Ÿ", `æ”¶åˆ°è¯·æ±‚ï¼Œå¼€å§‹ç§»åŠ¨æŸåæ–‡ä»¶`, true);

            // å‘é€è¯·æ±‚ç»™åç«¯
            const request = {
                directory: dir,
                scanMode: "movebroken",
                scanType: ""
            };
            ws.send(JSON.stringify(request));
        });
    }
    if (moveNormalButton != null){
        moveNormalButton.addEventListener('click', () => {
            if (isScanning) return;
            
            const dir = directoryPath.value.trim();
            if (!dir) {
                alert("è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ç›®å½•è·¯å¾„ï¼");
                return;
            }

            // çŠ¶æ€åˆ‡æ¢å’Œæ¸…ç†
            logMessage("ç³»ç»Ÿ", `æ”¶åˆ°è¯·æ±‚ï¼Œå¼€å§‹ç§»åŠ¨æ­£å¸¸æ–‡ä»¶`, true);

            // å‘é€è¯·æ±‚ç»™åç«¯
            const request = {
                directory: dir,
                scanMode: "movenormal",
                scanType: ""
            };
            ws.send(JSON.stringify(request));
        });
    }
</script>
</body>
</html>